<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Smart Background Remover</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
  :root {
    --primary: #6366f1;
    --primary-dark: #4f46e5;
    --success: #10b981;
    --success-dark: #059669;
    --warning: #f59e0b;
    --warning-dark: #d97706;
    --gray: #6b7280;
    --gray-dark: #4b5563;
    --light: #f8fafc;
    --white: #ffffff;
    --shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.1);
    --radius: 16px;
    --radius-sm: 12px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, #f0f4ff 0%, #fdf2ff 100%);
    color: #1f2937;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
  }

  /* Navigation Bar */
  .navbar {
    width: 100%;
    max-width: 900px;
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 16px 24px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 16px;
  }

  .nav-brand {
    font-size: 20px;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary), var(--success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .nav-brand i {
    font-size: 22px;
  }

  .nav-links {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  .social-links {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .social-link {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--white);
    text-decoration: none;
    transition: var(--transition);
    font-size: 16px;
  }

  .social-link:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
  }

  .github {
    background: linear-gradient(135deg, #333, #000);
  }

  .youtube {
    background: linear-gradient(135deg, #ff0000, #cc0000);
  }

  .instagram {
    background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
  }

  .tiktok {
    background: linear-gradient(135deg, #000000, #00f2ea, #ff0050);
  }

  .github-star {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: var(--white);
    text-decoration: none;
    border-radius: var(--radius-sm);
    font-weight: 600;
    font-size: 14px;
    transition: var(--transition);
  }

  .github-star:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .github-star i {
    font-size: 16px;
  }

  .card {
    background: var(--white);
    padding: 40px;
    border-radius: 24px;
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 900px;
    position: relative;
    overflow: hidden;
    margin-top: 0;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary), var(--success));
  }

  .header {
    text-align: center;
    margin-bottom: 32px;
  }

  h1 {
    margin: 0 0 12px;
    font-size: 32px;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary), var(--success));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }

  .subtitle {
    margin: 0;
    color: var(--gray);
    font-size: 16px;
    line-height: 1.5;
    max-width: 600px;
    margin: 0 auto;
  }

  .dropzone {
    position: relative;
    border: 2px dashed #e5e7eb;
    border-radius: var(--radius);
    padding: 48px 32px;
    background: var(--light);
    cursor: pointer;
    transition: var(--transition);
    margin: 0 auto 32px;
    text-align: center;
    max-width: 600px;
  }

  .dropzone:hover {
    border-color: var(--primary);
    background: #f5f7ff;
    transform: translateY(-2px);
    box-shadow: var(--shadow);
  }

  .dropzone:hover .upload-icon {
    transform: scale(1.1);
  }

  .upload-icon {
    width: 64px;
    height: 64px;
    margin: 0 auto 20px;
    background: linear-gradient(135deg, var(--primary), var(--success));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: var(--transition);
  }

  .upload-icon svg {
    width: 32px;
    height: 32px;
    fill: var(--white);
  }

  .drop-text {
    pointer-events: none;
    font-size: 18px;
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
  }

  .drop-hint {
    pointer-events: none;
    font-size: 14px;
    color: var(--gray);
  }

  .dropzone input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    cursor: pointer;
  }

  .controls {
    display: none; /* Hide the controls from main page */
  }

  .status-container {
    background: var(--light);
    border-radius: var(--radius-sm);
    padding: 18px;
    margin-bottom: 32px;
    text-align: center;
  }

  .status {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .status::before {
    content: '';
    width: 10px;
    height: 10px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .preview-container {
    display: none; /* Hide the main preview container */
  }

  .footer {
    margin-top: 32px;
    text-align: center;
    font-size: 14px;
    color: var(--gray);
  }

  .loader {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    animation: fadeIn 0.3s ease;
  }

  .modal-overlay.active {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal {
    background: var(--white);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 1200px;
    max-height: 90vh;
    overflow: auto;
    animation: slideUp 0.3s ease;
    position: relative;
  }

  @keyframes slideUp {
    from { transform: translateY(30px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    padding: 24px 32px;
    border-bottom: 2px solid #f3f4f6;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(90deg, var(--primary), var(--success));
    border-radius: var(--radius) var(--radius) 0 0;
  }

  .modal-title {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--white);
    letter-spacing: -0.5px;
  }

  .close-btn {
    background: rgba(255, 255, 255, 0.2);
    color: var(--white);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
    font-size: 20px;
  }

  .close-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
  }

  .modal-body {
    padding: 32px;
  }

  .modal-preview-container {
    display: flex;
    flex-direction: column;
    gap: 32px;
    margin-bottom: 32px;
  }

  @media (min-width: 768px) {
    .modal-preview-container {
      flex-direction: row;
    }
  }

  .modal-preview-box {
    background: var(--light);
    border-radius: var(--radius);
    padding: 24px;
    text-align: center;
    flex: 1;
    min-height: 400px;
    display: flex;
    flex-direction: column;
  }

  .modal-preview-label {
    display: block;
    font-size: 16px;
    font-weight: 600;
    color: var(--gray-dark);
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e5e7eb;
  }

  .modal-preview-content {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 350px;
    overflow: hidden;
    border-radius: 12px;
    background: repeating-conic-gradient(#f8fafc 0% 25%, #ffffff 0% 50%) 
                50% / 20px 20px;
  }

  .modal-preview-content img, 
  .modal-preview-content canvas {
    max-width: 100%;
    max-height: 350px;
    width: auto;
    height: auto;
    border-radius: 8px;
    box-shadow: var(--shadow);
    display: block;
    object-fit: contain;
  }

  .modal-preview-placeholder {
    color: var(--gray);
    font-size: 16px;
    padding: 20px;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
  }

  .modal-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    justify-content: center;
    padding-top: 24px;
    border-top: 2px solid #f3f4f6;
  }

  .modal-controls button {
    min-width: 180px;
  }

  .hidden {
    display: none;
  }

  .result-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-top: 24px;
    flex-wrap: wrap;
  }

  .result-actions button {
    min-width: 180px;
    padding: 16px 24px;
    font-size: 16px;
    font-weight: 600;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    letter-spacing: -0.2px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
  }

  .result-actions button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(rgba(255,255,255,0.1), rgba(255,255,255,0));
    opacity: 0;
    transition: var(--transition);
  }

  .result-actions button:hover::before {
    opacity: 1;
  }

  .result-actions button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
    box-shadow: none !important;
  }

  .result-actions button:not(:disabled):hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
  }

  .result-actions button i {
    font-size: 18px;
  }

  .btn-person {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: var(--white);
  }

  .btn-person:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--primary-dark), #4338ca);
  }

  .btn-person.active {
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
  }

  .btn-background {
    background: linear-gradient(135deg, var(--warning), var(--warning-dark));
    color: var(--white);
  }

  .btn-background:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--warning-dark), #b45309);
  }

  .btn-background.active {
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
  }

  .btn-format {
    background: linear-gradient(135deg, var(--gray), var(--gray-dark));
    color: var(--white);
  }

  .btn-format:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--gray-dark), #374151);
  }

  .btn-format.active {
    box-shadow: 0 0 0 3px rgba(107, 114, 128, 0.3);
  }

  .btn-download {
    background: linear-gradient(135deg, var(--success), var(--success-dark));
    color: var(--white);
  }

  .btn-download:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--success-dark), #047857);
  }

  .btn-download.active {
    box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
  }

  .btn-another {
    background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    color: var(--white);
  }

  .btn-another:hover:not(:disabled) {
    background: linear-gradient(135deg, #7c3aed, #6d28d9);
  }

  .btn-another.active {
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.3);
  }

  /* Progress indicator */
  .progress-container {
    width: 100%;
    max-width: 400px;
    margin: 20px auto;
    background: #f3f4f6;
    border-radius: 10px;
    overflow: hidden;
    display: none;
  }

  .progress-bar {
    height: 6px;
    background: linear-gradient(90deg, var(--primary), var(--success));
    border-radius: 10px;
    width: 0%;
    transition: width 0.3s ease;
  }

  /* Responsive Navigation */
  @media (max-width: 768px) {
    .navbar {
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: 16px;
    }
    
    .nav-links {
      justify-content: center;
    }
    
    .social-links {
      margin-top: 8px;
    }
    
    .card {
      padding: 24px;
    }
    
    .header h1 {
      font-size: 28px;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .result-actions {
      flex-direction: column;
      align-items: center;
    }
    
    .result-actions button {
      width: 100%;
      max-width: 280px;
    }
    
    .modal-preview-container {
      flex-direction: column;
    }
  }

  /* Button animations */
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .pulse {
    animation: pulse 1.5s infinite;
  }

  /* Tooltip */
  .tooltip {
    position: relative;
    display: inline-block;
  }

  .tooltip .tooltiptext {
    visibility: hidden;
    width: 140px;
    background-color: #374151;
    color: var(--white);
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 1;
    bottom: 125%;
    left: 50%;
    margin-left: -70px;
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 12px;
    font-weight: 500;
  }

  .tooltip .tooltiptext::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: #374151 transparent transparent transparent;
  }

  .tooltip:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }
</style>
  </head>
  <body>

    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="nav-brand">
        <i class="fas fa-magic"></i>
        <span>Smart Background Remover</span>
      </div>

      <div class="nav-links">
        <div class="social-links">
          <a href="https://github.com/mintesnot-yess" target="_blank"
            class="social-link github" title="GitHub">
            <i class="fab fa-github"></i>
          </a>
          <a href="https://www.youtube.com/@mint_snot" target="_blank"
            class="social-link youtube" title="YouTube">
            <i class="fab fa-youtube"></i>
          </a>
          <a href="https://www.instagram.com/mintesnot_yess/" target="_blank"
            class="social-link instagram" title="Instagram">
            <i class="fab fa-instagram"></i>
          </a>
          <a href="https://www.tiktok.com/@mint_snotyess" target="_blank"
            class="social-link tiktok" title="TikTok">
            <i class="fab fa-tiktok"></i>
          </a>
        </div>

        <a href="https://github.com/mintesnot-yess/bg-remover" target="_blank"
          class="github-star" title="Star on GitHub">
          <i class="fas fa-star"></i>
          <span>Star on GitHub</span>
        </a>
      </div>
    </nav>

    <div class="card">
      <div class="header">
        <h1>Smart Background Remover</h1>
        <p class="subtitle">Upload an image and automatically remove the
          background. Supports PNG, WebP, and JPG formats.</p>
      </div>

      <div class="dropzone" id="dropzone">
        <div class="upload-icon">
          <svg viewBox="0 0 24 24">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
        </div>
        <div class="drop-text">Drag & drop your image here</div>
        <div class="drop-hint">or click to browse files (JPG, PNG, WebP)</div>
        <input type="file" id="upload" accept="image/*">
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div class="status-container">
        <p class="status" id="status">Ready — upload an image to begin</p>
      </div>

      <!-- Controls hidden from main page -->
      <div class="controls" style="display: none;">
        <button id="go" class="btn-primary" disabled>
          <span>Remove Background</span>
        </button>
      </div>

      <!-- Hidden preview containers (not displayed in main card) -->
      <div class="preview-container" style="display: none;">
        <div class="preview-box">
          <span class="preview-label">Original Image</span>
          <div class="preview-content">
            <img id="orig" class="hidden">
            <div id="orig-placeholder" class="preview-placeholder">Original
              image will appear here</div>
          </div>
        </div>
        <div class="preview-box">
          <span class="preview-label">Result</span>
          <div class="preview-content">
            <canvas id="out" class="hidden"></canvas>
            <div id="out-placeholder" class="preview-placeholder">Processed
              result will appear here</div>
          </div>
        </div>
      </div>

      <div class="footer">
        <p>AI-powered background removal • Fast processing • High quality
          results</p>
        <p style="margin-top: 8px; font-size: 13px;">
          Developed by <strong>Mintesnot</strong> •
          <a href="https://github.com/mintesnot-yess/bg-remover" target="_blank"
            style="color: var(--primary); text-decoration: none; font-weight: 600;">
            View on GitHub
          </a>
        </p>
      </div>
    </div>

    <!-- Modal Popup -->
    <div class="modal-overlay" id="modalOverlay">
      <div class="modal">
        <div class="modal-header">
          <h2 class="modal-title">Background Removed Successfully!</h2>
          <button class="close-btn" id="closeModal">×</button>
        </div>

        <div class="modal-body">
          <div class="modal-preview-container">
            <div class="modal-preview-box">
              <span class="modal-preview-label">Result</span>
              <div class="modal-preview-content">
                <canvas id="modal-out"></canvas>
              </div>
            </div>
            <div class="modal-preview-box">
              <span class="modal-preview-label">Original Image</span>
              <div class="modal-preview-content">
                <img id="modal-orig">
              </div>
            </div>
          </div>

          <div class="result-actions">
            <button id="modal-person" class="btn-person active tooltip">
              <i class="fas fa-user"></i>
              <span>Keep Person</span>
              <span class="tooltiptext">Show person with transparent
                background</span>
            </button>
            <button id="modal-background" class="btn-background tooltip">
              <i class="fas fa-mountain"></i>
              <span>Keep Background</span>
              <span class="tooltiptext">Show background without person</span>
            </button>
            <button id="modal-format" class="btn-format tooltip">
              <i class="fas fa-file-image"></i>
              <span>Save as JPG</span>
              <span class="tooltiptext">Change download format</span>
            </button>
            <button id="modal-download" class="btn-download pulse tooltip">
              <i class="fas fa-download"></i>
              <span>Download Image</span>
              <span class="tooltiptext">Download the processed image</span>
            </button>
            <button id="modal-another" class="btn-another tooltip">
              <i class="fas fa-upload"></i>
              <span>Upload Another</span>
              <span class="tooltiptext">Process another image</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
  import { FilesetResolver, ImageSegmenter } from 
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs";

  const status = document.getElementById('status');
  const dropzone = document.getElementById('dropzone');
  const uploadInput = document.getElementById('upload');
  const progressContainer = document.getElementById('progressContainer');
  const progressBar = document.getElementById('progressBar');
  
  // Modal elements
  const modalOverlay = document.getElementById('modalOverlay');
  const closeModalBtn = document.getElementById('closeModal');
  const modalOrigImg = document.getElementById('modal-orig');
  const modalOutCanvas = document.getElementById('modal-out');
  const modalPersonBtn = document.getElementById('modal-person');
  const modalBackgroundBtn = document.getElementById('modal-background');
  const modalFormatBtn = document.getElementById('modal-format');
  const modalDownloadBtn = document.getElementById('modal-download');
  const modalAnotherBtn = document.getElementById('modal-another');
  
  // Create canvas element for processing
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  let segmenter = null;
  let keepForeground = true; // true = keep person, false = keep background
  let currentFormat = 'png'; // png, webp, jpg
  let currentImage = null;

  async function init() {
    try {
      status.innerHTML = '<span class="loader"></span> Loading AI model...';
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
      );
      segmenter = await ImageSegmenter.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://storage.googleapis.com/mediapipe-models/image_segmenter/selfie_segmenter/float16/latest/selfie_segmenter.tflite"
        },
        runningMode: "IMAGE",
        outputCategoryMask: true,
        outputType: "CATEGORY_MASK"
      });
      status.textContent = "Ready — upload an image to begin";
    } catch (e) {
      console.error("Failed to load model:", e);
      status.textContent = "Error loading model. Check console.";
    }
  }

  // Drag & Drop Support
  dropzone.addEventListener('dragover', e => {
    e.preventDefault();
    dropzone.style.background = '#f5f7ff';
    dropzone.style.borderColor = 'var(--primary)';
  });

  dropzone.addEventListener('dragleave', () => {
    dropzone.style.background = 'var(--light)';
    dropzone.style.borderColor = '#e5e7eb';
  });

  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    dropzone.style.background = 'var(--light)';
    dropzone.style.borderColor = '#e5e7eb';
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  uploadInput.onchange = e => {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  };

  function handleFile(file) {
    if (!file.type.startsWith('image/')) {
      alert('Please select an image file (JPG, PNG, or WebP)');
      return;
    }
    
    // Update dropzone appearance
    dropzone.style.background = '#e8f5e9';
    dropzone.style.borderColor = 'var(--success)';
    dropzone.querySelector('.upload-icon').style.background = 'linear-gradient(135deg, var(--success), var(--success-dark))';
    dropzone.querySelector('.drop-text').textContent = 'Processing image...';
    dropzone.querySelector('.drop-hint').textContent = file.name;
    
    // Show progress bar
    progressContainer.style.display = 'block';
    progressBar.style.width = '30%';
    
    const objectUrl = URL.createObjectURL(file);
    currentImage = new Image();
    currentImage.src = objectUrl;
    modalOrigImg.src = objectUrl; // Set for modal
    
    currentImage.onload = () => {
      progressBar.style.width = '60%';
      status.innerHTML = '<span class="loader"></span> Processing image...';
      
      // Start processing immediately
      setTimeout(() => {
        processImage();
      }, 100);
    };
  }

  async function processImage() {
    if (!segmenter || !currentImage) return;
    
    try {
      progressBar.style.width = '80%';
      status.innerHTML = '<span class="loader"></span> Removing background...';
      
      const result = await segmenter.segment(currentImage);
      const mask = result.categoryMask;

      let maskData;
      if (mask.getBuffer) {
        maskData = new Uint8Array(mask.getBuffer());
      } else if (mask.getAsFloat32Array) {
        const floatData = await mask.getAsFloat32Array();
        maskData = new Uint8Array(floatData.length);
        for (let i = 0; i < floatData.length; i++) {
          maskData[i] = Math.round(floatData[i] * 255);
        }
      } else {
        throw new Error("Unsupported mask type");
      }

      // Use original dimensions for processing
      const origWidth = currentImage.naturalWidth;
      const origHeight = currentImage.naturalHeight;

      canvas.width = origWidth;
      canvas.height = origHeight;
      modalOutCanvas.width = origWidth;
      modalOutCanvas.height = origHeight;
      
      // Calculate display size for canvas
      const MAX_DISPLAY_WIDTH = 400;
      let displayWidth = origWidth;
      let displayHeight = origHeight;

      if (displayWidth > MAX_DISPLAY_WIDTH) {
        displayHeight = Math.round(displayHeight * (MAX_DISPLAY_WIDTH / displayWidth));
        displayWidth = MAX_DISPLAY_WIDTH;
      }

      modalOutCanvas.style.width = displayWidth + 'px';
      modalOutCanvas.style.height = displayHeight + 'px';
      modalOrigImg.style.width = displayWidth + 'px';
      modalOrigImg.style.height = displayHeight + 'px';

      // Draw original image onto canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
      
      const modalCtx = modalOutCanvas.getContext('2d');
      modalCtx.clearRect(0, 0, modalOutCanvas.width, modalOutCanvas.height);
      modalCtx.drawImage(currentImage, 0, 0, modalOutCanvas.width, modalOutCanvas.height);

      // Create temp canvas for blurred mask
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;

      // Draw mask as grayscale
      const maskImageData = tempCtx.createImageData(canvas.width, canvas.height);
      for (let i = 0; i < maskData.length; i++) {
        maskImageData.data[i * 4 + 0] = maskData[i]; // R
        maskImageData.data[i * 4 + 1] = maskData[i]; // G
        maskImageData.data[i * 4 + 2] = maskData[i]; // B
        maskImageData.data[i * 4 + 3] = 255;         // A
      }
      tempCtx.putImageData(maskImageData, 0, 0);

      // Apply Gaussian blur for edge feathering
      tempCtx.filter = 'blur(3px)';
      tempCtx.drawImage(tempCanvas, 0, 0);

      // Get blurred mask data
      const blurredMaskData = tempCtx.getImageData(0, 0, canvas.width, canvas.height).data;

      // Apply blurred mask to alpha channel
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const modalImageData = modalCtx.getImageData(0, 0, modalOutCanvas.width, modalOutCanvas.height);
      
      for (let i = 0; i < maskData.length; i++) {
        const alpha = blurredMaskData[i * 4];
        imageData.data[i * 4 + 3] = keepForeground ? alpha : 255 - alpha;
        modalImageData.data[i * 4 + 3] = keepForeground ? alpha : 255 - alpha;
      }

      ctx.putImageData(imageData, 0, 0);
      modalCtx.putImageData(modalImageData, 0, 0);

      progressBar.style.width = '100%';
      
      // Show modal with results
      setTimeout(() => {
        modalOverlay.classList.add('active');
        progressContainer.style.display = 'none';
        progressBar.style.width = '0%';
        
        // Update button states
        updateButtonStates();
        
        // Set format button text
        modalFormatBtn.innerHTML = `<i class="fas fa-file-image"></i><span>Save as ${currentFormat.toUpperCase()}</span>`;
      }, 300);

    } catch (e) {
      console.error("Processing error:", e);
      status.textContent = "Error processing image. Please try another.";
      progressContainer.style.display = 'none';
      progressBar.style.width = '0%';
      
      // Reset dropzone
      dropzone.style.background = 'var(--light)';
      dropzone.style.borderColor = '#e5e7eb';
      dropzone.querySelector('.upload-icon').style.background = 'linear-gradient(135deg, var(--primary), var(--success))';
      dropzone.querySelector('.drop-text').textContent = 'Drag & drop your image here';
      dropzone.querySelector('.drop-hint').textContent = 'or click to browse files (JPG, PNG, WebP)';
    }
  }

  function updateButtonStates() {
    // Update active state for person/background buttons
    if (keepForeground) {
      modalPersonBtn.classList.add('active');
      modalBackgroundBtn.classList.remove('active');
    } else {
      modalPersonBtn.classList.remove('active');
      modalBackgroundBtn.classList.add('active');
    }
  }

  // Modal Controls
  closeModalBtn.onclick = () => {
    modalOverlay.classList.remove('active');
  };

  modalPersonBtn.onclick = async () => {
    if (keepForeground) return; // Already keeping person
    
    keepForeground = true;
    updateButtonStates();
    
    // Show loading state
    const originalText = modalPersonBtn.innerHTML;
    modalPersonBtn.innerHTML = '<span class="loader"></span> Processing...';
    modalPersonBtn.disabled = true;
    modalBackgroundBtn.disabled = true;
    
    // Re-process with new setting
    if (currentImage) {
      await processImage();
    }
    
    // Restore button state
    modalPersonBtn.innerHTML = originalText;
    modalPersonBtn.disabled = false;
    modalBackgroundBtn.disabled = false;
  };

  modalBackgroundBtn.onclick = async () => {
    if (!keepForeground) return; // Already keeping background
    
    keepForeground = false;
    updateButtonStates();
    
    // Show loading state
    const originalText = modalBackgroundBtn.innerHTML;
    modalBackgroundBtn.innerHTML = '<span class="loader"></span> Processing...';
    modalPersonBtn.disabled = true;
    modalBackgroundBtn.disabled = true;
    
    // Re-process with new setting
    if (currentImage) {
      await processImage();
    }
    
    // Restore button state
    modalBackgroundBtn.innerHTML = originalText;
    modalPersonBtn.disabled = false;
    modalBackgroundBtn.disabled = false;
  };

  modalFormatBtn.onclick = () => {
    if (currentFormat === 'png') {
      currentFormat = 'jpg';
    } else if (currentFormat === 'jpg') {
      currentFormat = 'webp';
    } else {
      currentFormat = 'png';
    }
    
    modalFormatBtn.innerHTML = `<i class="fas fa-file-image"></i><span>Save as ${currentFormat.toUpperCase()}</span>`;
  };

  modalDownloadBtn.onclick = () => {
    let filename = `background-removed.${currentFormat}`;
    let mimeType = `image/${currentFormat === 'jpg' ? 'jpeg' : currentFormat}`;

    // If saving as JPG/WebP, fill background
    if (currentFormat !== 'png') {
      const bgCanvas = document.createElement('canvas');
      const bgCtx = bgCanvas.getContext('2d');
      bgCanvas.width = canvas.width;
      bgCanvas.height = canvas.height;

      // Fill with white background
      bgCtx.fillStyle = '#ffffff';
      bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);

      // Draw transparent image over it
      bgCtx.drawImage(canvas, 0, 0);

      // Convert to desired format
      bgCanvas.toBlob(blob => {
        if (blob) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          URL.revokeObjectURL(a.href);
        }
      }, mimeType, 0.9);

    } else {
      // Save as PNG (transparent)
      canvas.toBlob(blob => {
        if (blob) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          URL.revokeObjectURL(a.href);
        }
      }, 'image/png');
    }
  };

  modalAnotherBtn.onclick = () => {
    modalOverlay.classList.remove('active');
    
    // Reset dropzone
    dropzone.style.background = 'var(--light)';
    dropzone.style.borderColor = '#e5e7eb';
    dropzone.querySelector('.upload-icon').style.background = 'linear-gradient(135deg, var(--primary), var(--success))';
    dropzone.querySelector('.drop-text').textContent = 'Drag & drop your image here';
    dropzone.querySelector('.drop-hint').textContent = 'or click to browse files (JPG, PNG, WebP)';
    
    // Clear file input
    uploadInput.value = '';
    
    status.textContent = "Ready — upload another image";
    currentImage = null;
  };

  // Close modal when clicking outside
  modalOverlay.onclick = (e) => {
    if (e.target === modalOverlay) {
      modalOverlay.classList.remove('active');
    }
  };

  // Close modal with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modalOverlay.classList.contains('active')) {
      modalOverlay.classList.remove('active');
    }
  });

  init();
</script>
  </body>
</html>